<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Air Monitoring System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#dashboard">
                <span class="badge bg-success me-2">Live</span>Smart Air Monitor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard" onclick="showTab('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#history" onclick="showTab('history')">History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about" onclick="showTab('about')">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="mb-3">Dashboard</h1>
                    <p class="text-muted">Real-time sensor readings and air quality status</p>
                </div>
            </div>

            <!-- Sensor Cards -->
            <div class="row g-4">
                <!-- Air Quality Card -->
                <div class="col-md-4">
                    <div class="card sensor-card air-quality-card">
                        <div class="card-body">
                            <h5 class="card-title">Air Quality</h5>
                            <div class="value-display" id="airQuality">--</div>
                            <div class="unit">PPM (CO2 equivalent)</div>
                            <div class="status-badge" id="airQualityStatus">
                                <span class="badge bg-secondary">Loading...</span>
                            </div>
                            <div class="status-description" id="airQualityDescription"></div>
                        </div>
                    </div>
                </div>

                <!-- Temperature Card -->
                <div class="col-md-4">
                    <div class="card sensor-card temperature-card">
                        <div class="card-body">
                            <h5 class="card-title">Temperature</h5>
                            <div class="value-display" id="temperature">--</div>
                            <div class="unit">°Celsius</div>
                            <div class="last-update">Last updated: <span id="tempTime">--:--</span></div>
                        </div>
                    </div>
                </div>

                <!-- Humidity Card -->
                <div class="col-md-4">
                    <div class="card sensor-card humidity-card">
                        <div class="card-body">
                            <h5 class="card-title">Humidity</h5>
                            <div class="value-display" id="humidity">--</div>
                            <div class="unit">%</div>
                            <div class="last-update">Last updated: <span id="humidityTime">--:--</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Legend -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Air Quality Status Legend</h6>
                            <div class="d-flex gap-3 flex-wrap">
                                <div><span class="badge bg-success">Good</span> < 50 PPM</div>
                                <div><span class="badge bg-warning text-dark">Moderate</span> 50–100 PPM</div>
                                <div><span class="badge bg-danger">Poor</span> > 100 PPM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content" style="display:none;">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="mb-3">History</h1>
                    <p class="text-muted">Last 20 sensor readings with trend visualization</p>
                </div>
            </div>

            <!-- Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Sensor Readings Trend</h5>
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Detailed Readings</h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="readingsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Air Quality (PPM)</th>
                                            <th>Temperature (°C)</th>
                                            <th>Humidity (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Tab -->
        <div id="about-tab" class="tab-content" style="display:none;">
            <div class="row">
                <div class="col-lg-8">
                    <h1 class="mb-4">About This Project</h1>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Project Description</h5>
                            <p>The Smart Air Monitoring System is an IoT project designed to monitor air quality, temperature, and humidity in real-time. It provides instant feedback on environmental conditions and maintains a historical record of readings for trend analysis.</p>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Hardware Components</h5>
                            <ul>
                                <li><strong>Arduino UNO:</strong> Microcontroller for sensor data acquisition</li>
                                <li><strong>MQ135 Gas Sensor:</strong> Detects air quality and CO2 equivalent levels</li>
                                <li><strong>DHT11 Sensor:</strong> Measures temperature and humidity</li>
                                <li><strong>USB Cable:</strong> Serial communication with PC</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">How It Works</h5>
                            <ol>
                                <li>Arduino UNO reads sensor data every 2 seconds</li>
                                <li>Sensor values are sent via USB serial connection</li>
                                <li>Python script receives and stores data in SQLite database</li>
                                <li>Flask web server provides real-time API endpoints</li>
                                <li>Web dashboard displays live readings and historical trends</li>
                            </ol>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Technology Stack</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Hardware:</h6>
                                    <ul class="small">
                                        <li>Arduino IDE</li>
                                        <li>C++ (Arduino)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Backend:</h6>
                                    <ul class="small">
                                        <li>Python 3</li>
                                        <li>Flask</li>
                                        <li>SQLite3</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <h6>Frontend:</h6>
                                    <ul class="small">
                                        <li>HTML5</li>
                                        <li>CSS3</li>
                                        <li>JavaScript</li>
                                        <li>Bootstrap 5</li>
                                        <li>Chart.js</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title">Project Status</h5>
                            <p><span class="badge bg-success">Active</span></p>
                            <hr>
                            <p class="small text-muted">Version: 1.0<br>Last Updated: 2025</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
    <script>
        let trendsChart = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load history data if history tab is clicked
            if (tabName === 'history') {
                loadHistoryData();
            }
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US');
        }

        function getAirQualityStatus(ppm) {
            if (ppm < 50) {
                return { badge: 'bg-success', text: 'Good', description: 'Air quality is excellent' };
            } else if (ppm < 100) {
                return { badge: 'bg-warning', text: 'Moderate', description: 'Air quality is acceptable' };
            } else {
                return { badge: 'bg-danger', text: 'Poor', description: 'Air quality is concerning' };
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                document.getElementById('airQuality').textContent = data.air_quality;
                document.getElementById('temperature').textContent = data.temperature;
                document.getElementById('humidity').textContent = data.humidity;
                
                const time = formatTime(data.timestamp);
                document.getElementById('tempTime').textContent = time;
                document.getElementById('humidityTime').textContent = time;
                
                const status = getAirQualityStatus(data.air_quality);
                document.getElementById('airQualityStatus').innerHTML = `<span class="badge ${status.badge}">${status.text}</span>`;
                document.getElementById('airQualityDescription').textContent = status.description;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function loadHistoryData() {
            try {
                const response = await fetch('/api/history');
                const readings = await response.json();
                
                // Update table
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                
                if (readings.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data available yet</td></tr>';
                } else {
                    readings.forEach(reading => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDateTime(reading.timestamp)}</td>
                            <td>${reading.air_quality}</td>
                            <td>${reading.temperature}</td>
                            <td>${reading.humidity}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                
                // Update chart
                updateChart(readings);
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function updateChart(readings) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const labels = readings.map(r => new Date(r.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Air Quality (PPM)',
                            data: readings.map(r => r.air_quality),
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Temperature (°C)',
                            data: readings.map(r => r.temperature),
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Humidity (%)',
                            data: readings.map(r => r.humidity),
                            borderColor: '#0dcaf0',
                            backgroundColor: 'rgba(13, 202, 240, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Air Quality (PPM)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'center',
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            }
                        }
                    }
                }
            });
        }

        // Initial load and auto-refresh
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
